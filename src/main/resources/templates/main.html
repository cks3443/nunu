<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <meta name="description" content=""/>
    <meta name="author" content=""/>
    <title></title>
    <!-- Favicon
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />-->
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v6.1.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css"/>
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet"
          type="text/css"/>

    <!-- Core theme CSS (includes Bootstrap)-->
    <link th:href="@{/css/styles.css}" rel="stylesheet"/>
    <link th:href="@{/css/newStyle.css}" rel="stylesheet"/>
    <link th:href="@{/css/main.css}" rel="stylesheet"/>

    <style type="text/css">
        @media all and (max-width: 600px) {
            .navbar-brand {
                display: none;
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }
        }

        .newButton1 {
            text-align: right;
            width: 98%;
        }

        .newButton1 a {
            padding: 0.5rem;
            color: white;
            border-radius: 2rem;
            border: 1px solid black;
            margin-top: 35px;
            background-color: black;
        }

        .login {
            margin-top: 7.8rem;
            background-color: black;
            border-radius: 30px !important;
        }

        .grey {
            color: darkgrey;
        }
    </style>
</head>
<body id="page-top">
<div class="container-fluid" id="app">
    <div class="row">

        <div class="col-2 side_bar" style="border-right: 1px solid #c5c5c5;" th:fragment="menubar">
            <a th:href="@{/posts/edit}" class="btn btn-primary btn-lg btn-block login" role="button">
                +
                NEW</a>
            <ul>
                <div class="sideLi">
                    <li><a th:href="@{#}"
                           v-on:click="set_post_state($event,'CONTINUE')"
                    >
                        Continues
                    </a></li>
                    <div></div>
                </div>
                <div class="sideLi">
                    <li><a th:href="@{#}"
                           v-on:click="set_post_state($event,'DONE')"
                    >
                        Done
                    </a></li>
                    <div></div>
                </div>
                <div class="sideLi">
                    <li><a th:href="@{#}"
                           v-on:click="set_post_state($event,'DELETE')"
                    >
                        Delete
                    </a></li>
                    <div></div>
                </div>
                <th:block sec:authorize="isAuthenticated()">
                    <div class="sideLi">
                        <li><a th:href="@{/logout}">
                            Logout
                        </a></li>
                        <div></div>
                    </div>
                </th:block>
            </ul>
            <hr/>
            <div class="column"><a th:href="@{/mypage}" class="btn btn-primary btn-xl sideBtn" type="submit"> ID</a>
            </div>
            <div class="column"><a th:href="@{/notice}" class="btn btn-primary btn-xl sideBtn" type="submit">noti</a>
            </div>
        </div>

        <div class="col-10">
            <div class="row">
                <!-- Navigation-->

                <nav th:replace="~{fragments/common_parts :: navbar}"></nav>

                <section class="page-section" id="contact">

                    <div class="viewbtn" style="text-align: center; padding-bottom:20px" th:fragment="viewbtn">
                        <a th:href="@{#}" style="border: 0 !important; opacity: unset;" type="button"
                           class="btn btn-outline-primary"

                           v-on:click="setViewNum($event, 1)"
                        >
                            <img class="" th:src="@{/assets/img/line.svg}" alt="..."/>
                        </a>
                        <a th:href="@{#}" style="border: 0 !important;  opacity: unset" type="button"
                           class="btn btn-outline-primary"

                           v-on:click="setViewNum($event, 2)"
                        >
                            <img class="" th:src="@{/assets/img/block.svg}" alt="..."/>
                        </a>
                        <a th:href="@{#}"
                           style="border: 0 !important;  opacity: unset" type="button"
                           class="btn btn-outline-primary"

                           v-on:click="setViewNum($event, 3)"
                        >
                            <img class="" th:src="@{/assets/img/list.svg}" alt="..."/>
                        </a>
                    </div>

                    <div class="container"
                         v-if="view_num == 1"
                    >
                        <!-- Section Form-->
                        <div>
                            <form class="formList">

                                <div class="divTable"
                                     v-for="(post,post_id) in posts"
                                >
                                    <div class="divTableBody">
                                        <div class="divTableRow">
                                            <div class="divTableCell firstRow"
                                            >
                                                <a
                                                        :href="'/posts/edit/' + post.id"
                                                >
                                                    {{post.title}}
                                                </a>
                                                <span
                                                        v-on:click="clickDeleteBtnHandler($event, post_id)"
                                                        v-if="post.delete_times == 0"
                                                >
                                                    <i class="fa-regular fa-circle">
                                                    </i>
                                                </span>
                                                <span
                                                        v-on:click="clickDeleteBtnHandler($event, post_id)"
                                                        v-else-if="post.delete_times == 1"

                                                        style="color: red; width: 12px;height: 12px;border-radius: 50%;"
                                                >
                                                    <i class="fa-regular fa-circle">
                                                    </i>
                                                </span>
                                            </div>
                                        </div>

                                        <div
                                                @click="onClickPost($event, post.id)"

                                                class="divTableRow"
                                                v-for="order in post.ord"
                                        >
                                            <div class="divTableCell">{{post.subs[order].heading}}</div>
                                        </div>

                                    </div>
                                </div>

                            </form>

                            <div th:replace="~{fragments/common_parts :: newButton}"></div>

                        </div>
                    </div>

                    <div class="container" v-if="view_num == 2"
                    >
                        <!-- Section Form-->
                        <div class="row justify-content-center">
                            <form>
                                <div
                                        style="
                                          display: grid;
                                          grid-template-columns: repeat(2, 1fr);
                                          gap: 10px;
                                        "
                                >
                                    <div class="divTable"
                                         v-for="(post,post_id) in posts"

                                    >
                                        <div class="divTableBody">
                                            <div class="divTableRow">
                                                <div class="divTableCell firstRow"
                                                >
                                                    <a
                                                            :href="'/posts/edit/' + post.id"
                                                    >
                                                        {{post.title}}
                                                    </a>
                                                    <span
                                                            v-on:click="clickDeleteBtnHandler($event, post_id)"
                                                            v-if="post.delete_times == 0"
                                                    >
                                                        <i class="fa-regular fa-circle"></i>
                                                    </span>
                                                    <span
                                                            v-on:click="clickDeleteBtnHandler($event, post_id)"
                                                            v-else

                                                            style="color: red; width: 12px;height: 12px;border-radius: 50%;"
                                                    >
                                                        <i class="fa-regular fa-circle"></i>
                                                    </span>

                                                </div>
                                            </div>

                                            <div
                                                    class="divTableRow"
                                                    v-for="order in post.ord"
                                            >
                                                <div class="divTableCell">{{post.subs[order].heading}}</div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </form>

                            <div th:replace="~{fragments/common_parts :: newButton}"></div>

                        </div>
                    </div>


                    <div class="container"
                         v-if="view_num == 3"
                    >
                        <!-- Section Form-->
                        <div class="">
                            <form class="formList">

                                <div
                                        class="divTable"

                                        v-for="(post,post_id) in posts"
                                >
                                    <div class="divTableBody">
                                        <div class="divTableRow">
                                            <div class="divTableCell firstRow">
                                                <a
                                                        v-bind:href="'/posts/edit/' + post.id"
                                                >
                                                    {{post.title}}
                                                </a>
                                                <span
                                                        v-on:click="clickDeleteBtnHandler($event, post_id)"
                                                        v-if="post.delete_times == 0"
                                                >
                                                        <i class="fa-regular fa-circle"></i>
                                                    </span>
                                                <span
                                                        v-on:click="clickDeleteBtnHandler($event, post_id)"
                                                        v-else

                                                        style="color: red; width: 12px;height: 12px;border-radius: 50%;"
                                                >
                                                        <i class="fa-regular fa-circle"></i>
                                                    </span>
                                            </div>

                                        </div>
                                    </div>
                                </div>

                            </form>

                            <div th:replace="~{fragments/common_parts :: newButton}"></div>

                        </div>
                    </div>


                </section>
            </div>
        </div>
    </div>
</div>
</body>

<script th:src="@{/webjars/vue/dist/vue.js}"></script>

<script>

    new Vue({
        el: '#app',
        data: {
            view_num: 1,
            posts: [],
            post_state: '[[${state}]]' // 'DONE', 'DELETE'
        },

        methods: {

            onClickPost: function (event, id) {
                window.location.replace('/posts/edit/' + id)
            },

            setViewNum: function (e, num) {
                e.preventDefault()

                this.view_num = num
            },

            set_posts: function () {
                fetch('/api/v1/posts/all', {method: 'POST'})
                    .then((r) => {
                        if (r.ok) return r.json()
                    })
                    .then((data) => {
                        this.posts = data.filter((d) => {
                            return (d.active != false && d.state == this.post_state)
                        })
                    })
            },

            set_post_state: function (e, state) {
                this.post_state = state

                this.set_posts()
            },

            clickDeleteBtnHandler: function (e, post_id) {

                e.preventDefault()

                if (this.posts[post_id].delete_times == 1) {
                    if (confirm('글이 완전히 삭제됩니다.\n 진행하시겠습니까?') == false) return
                }

                this.posts[post_id].delete_times += 1

                if (this.posts[post_id].delete_times == 2) {

                    if (this.posts[post_id].state == 'DELETE') {

                        let _id = this.posts[post_id].id
                        fetch(`/posts/${_id}/disable`, {method: 'POST'})
                            .then((r) => {
                                if (r.ok) {
                                    this.set_posts()
                                    return
                                }
                            })

                    } else {
                        this.posts[post_id].state = 'DELETE'

                        const form = new FormData()
                        form.append('post_str', JSON.stringify(this.posts[post_id]))

                        fetch('/api/v1/posts/save', {method: 'POST', body: form})
                            .then((r) => {
                                if (r.ok) {
                                    this.posts = this.posts.filter((post) => {
                                        return post.state == this.post_state
                                    })

                                }
                            })
                    }

                }
            },
        },

        beforeMount: function () {
            this.set_posts()
        }

    })

</script>
</html>
